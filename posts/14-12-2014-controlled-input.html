<html>
  <head>
    <meta charset="utf-8"/>
    <title>nil/recur</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <link href="../css/screen.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <h1><a class="navbar-brand" href="/nil-recur/index.html">nil/recur</a></h1>
        </div>
        <!-- nav links -->
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="/nil-recur/index.html">Home</a></li>
            <li ><a href="/nil-recur/archives.html">Archives</a></li>
            
            <li >
              <a href="/nil-recur/pages/about.html">About</a>
            </li>
            
            <li><a href="/nil-recur/feed.xml">RSS</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div id="wrapper" class="container">
      <div class="row">
        <div class="col-md-8">
          <div id="content">
            
<div id="post">
    <div id="post-header">
        <h2>Controlled and Uncontrolled input</h2>
        <p class="date">December 14, 2014</p>
    </div>
    <div>
        
        <p><a href='http://facebook.github.io/react/'>React</a> tries as much as possible to be <em>declarative</em>: The body of the <code>render</code> method is a description of the component <em>at any point in time</em>. Some input elements pose an interesting challange to this problem:</p><pre><code>&lt;input type=&quot;text&quot; value={this.props.name} onChange=... /&gt;
</code></pre><p>Given that we specify that the value of the input is <code>this.props.value</code>, and props are treated immutably by react, what should happen if we type something into the input box? If we change the content of the input we break the declarative model of React because the specified value does not match the actual content.</p><p>In React parlance, there is a difference between <a href='http://facebook.github.io/react/docs/forms.html#controlled-components'>controlled and uncontrolled components</a>. A controlled component will always contain the value specified in the <code>value</code> attribute. Controlled components are preferred because they preserve the overall declarative nature of React. The <code>onChange</code> callback must somehow cause a re-render so that the value property can be updated:</p><pre><code>var NameInput = React.createClass&#40;{
  render: function&#40;&#41; {
    return &#40;
      &lt;input type=&quot;text&quot;
             value={this.props.name.toUpperCase&#40;&#41;}
             onChange={this.handleChange}/&gt;
    &#41;;
  },

  handleChange: function&#40;evt&#41; {
    this.props.nameChange&#40;evt.target.value&#41;;
  }
}&#41;;

var SomeForm = React.createClass&#40;{
  getInitialState: function&#40;&#41; {
    return {name: &quot;&quot;,
            age: &quot;&quot;};
  },

  render: function&#40;&#41; {
    return &#40;
      &lt;ul&gt;
       &lt;li&gt;Name: &lt;NameInput name={this.state.name}
                            nameChange={this.handleNameChange}/&gt;&lt;/li&gt;
       &lt;li&gt;Age: ...&lt;/li&gt;
      &lt;/ul&gt;
    &#41;;
  },

  handleNameChange: function&#40;name&#41; {
    this.setState&#40;{name: name}&#41;;
  }
}&#41;;
</code></pre><p>Note that the <code>NameInput</code> component is completely stateless. At any point in time, the component will display the value of <code>this.props.name.toUpperCase&#40;&#41;</code>. It is up to the <code>onChange</code> callback to decide what to do if the user types something into the box. There is no default behaviour like <em>"add the typed letter at cursor position"</em>.</p><p>React also has a concept of uncontrolled components where instead of specifying <code>value</code> you use <code>defaultValue</code> and this value will be used for the initial render and after that the textbox behaves like a standard html input element. Note that uncontrolled components breaks the declarativeness. The words <em>"initial render"</em> and <em>"after"</em> should make it clear that the render function no longer specifies how the component should render at any point in time.</p><h3><a name="input&#95;components&#95;in&#95;om"></a>Input components in Om</h3><p>While working with input elements in Om I was surprised to realize that my components did not behave like controlled components does in React. After some digging I realized that the behaviour seemed to be intentional, since <a href='https://github.com/swannodette/om/blob/master/src/om/dom.cljs#L7-L36'>Om wraps React input components in its own stateful versions</a>. The reason for this is that Om does rendering asynchronously via <code>requestAnimationFrame</code> and it turns out that React does not fully support this mode of rendering.</p><p>As an example, consider the following application:</p><pre><code>&#40;def app-state &#40;atom {:text &quot;foo&quot;}&#41;&#41;

&#40;defn my-input &#91;app&#93;
  &#40;reify
    om/IRender
    &#40;render &#91;this&#93;
      &#40;dom/input
        #js {:type &quot;text&quot;
             :value &#40;.toUpperCase &#40;:text app&#41;&#41;
             :onChange #&#40;if &#40;&lt; &#40;count app&#41; 10&#41;
                          &#40;om/transact! app
                                        :text
                                        &#40;constantly &#40;-&gt; % .-target .-value&#41;&#41;&#41;&#41;}&#41;&#41;&#41;&#41;

&#40;om/root
  my-input
  app-state
  {:target &#40;. js/document &#40;getElementById &quot;app&quot;&#41;&#41;}&#41;
</code></pre><p>If you try to run this application you will notice two interesting things</p><ol><li>The input text is kept in upper case. However, if you try to add a character to the middle of the text the cursor will jump to the last position. If there is no transformation done (i.e., <code>:value &#40;:text app&#41;</code> instead of <code>:value &#40;.toUpperCase &#40;:text app&#41;&#41;</code>) the cursor will stay at the correct position.</li><li>The app-state is updated only if the text is less that 10 characters long. It is still possible to type more characters into the input box and in that case <em>the local state of the component differs from the application state</em>.</li></ol><h3><a name="input&#95;components&#95;in&#95;reagent"></a>Input components in Reagent</h3><p>Reagent also does asynchronous rendering and as such should be battling with the same issues, and indeed <a href='https://github.com/reagent-project/reagent/blob/master/src/reagent/impl/template.cljs#L82-L140'>it does</a>. I have not yet been able to completely understand this implementation but it seems like an attempt to keep the semantics of Reacts controlled components even in the case of asynchronous rendering.</p><p>It seems like this is not an easy task. For example, if you try this short reagent code snippet (which is very similar to the Om example above)</p><pre><code>&#40;defn my-input &#91;on-change text&#93;
  &#91;:div &#91;:input {:type &quot;text&quot;
                 :value &#40;.toUpperCase text&#41;
                 :on-change #&#40;if &#40;&lt; &#40;count text&#41; 10&#41;
                               &#40;on-change &#40;-&gt; % .-target .-value&#41;&#41;&#41;}&#93;&#93;&#41;

&#40;def text &#40;reagent/atom &quot;foo&quot;&#41;&#41;

&#40;defn main-page &#91;&#93;
  &#91;my-input #&#40;reset! text %&#41; @text&#93;&#41;

&#40;defn init! &#91;&#93;
  &#40;reagent/render-component &#91;main-page&#93; &#40;.getElementById js/document &quot;app&quot;&#41;&#41;&#41;
</code></pre><ol><li>You will notice the same behaviour as in the Om example: If you type a character in the middle of the text the cursor jumps to the last position.</li><li>The state of the <code>text</code> atom and the rendered text in the component seems to be kept in sync since it is not possible to type more than 10 characters into the input box.</li></ol><h3><a name="conclusions"></a>Conclusions</h3><p>It is unfortunate that asynchronous rendering does not work properly in React. However, this is hardly the fault of React, since they are pretty clear in their communication with the community that rendering with <code>requestAnimationFrame</code> is simply <a href='https://groups.google.com/forum/#!msg/reactjs/LkTihnf6Ey8/FgFvvf33GckJ'>not supported</a></p><blockquote><p> Let me repeat myself: rAF batching is not supported. It is not a priority for us because it does not solve any real problems that I know of and makes things much harder to reason about. </p></blockquote><p>It is interesting that the various Clojurescript React wrappers choose async rendering as their model when the underlying library that they rely on does not fully support it.</p>
    </div>
    
    <div id="tags">
        <b>Tags: </b>
        
        <a href="/nil-recur/tags/Reagent.html">Reagent</a>
        
        <a href="/nil-recur/tags/requestAnimationFrame.html">requestAnimationFrame</a>
        
        <a href="/nil-recur/tags/Om.html">Om</a>
        
        <a href="/nil-recur/tags/React.html">React</a>
        
    </div>
    

    <div id="prev-next">
        
        
        
        <a href="/nil-recur/posts/7-12-2014-om-table.html">Reusable Om components, part 2 &raquo;</a>
        
    </div>

    


</div>

          </div>
        </div>

        <div class="col-md-3">
          <div id="sidebar">
            <h3>Links</h3>
            <ul id="links">
              <li><a href="https://github.com/jonase">My Github</a></li>
              <li><a href="https://twitter.com/jonasenlund">Twitter</a></li>
              
            </ul>
            <div id="recent">
              <h3>Recent Posts</h3>
              <ul>
                
                <li><a href="/nil-recur/posts/14-12-2014-controlled-input.html">Controlled and Uncontrolled input</a></li>
                
                <li><a href="/nil-recur/posts/7-12-2014-om-table.html">Reusable Om components, part 2</a></li>
                
                <li><a href="/nil-recur/posts/29-11-2014-om-select.html">Reusable Om components, part 1</a></li>
                
              </ul>
            </div>
            <div id="tags">
              <h3>Tags</h3>
              <ul>
                
                <li><a href="/nil-recur/tags/Clojurescript.html">Clojurescript</a></li>
                
                <li><a href="/nil-recur/tags/React.html">React</a></li>
                
                <li><a href="/nil-recur/tags/Om.html">Om</a></li>
                
                <li><a href="/nil-recur/tags/requestAnimationFrame.html">requestAnimationFrame</a></li>
                
                <li><a href="/nil-recur/tags/Reagent.html">Reagent</a></li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>
      <footer>Copyright &copy; 2014 Jonas Enlund
        <p style="text-align: center;">
          Powered by <a href="https://github.com/lacarmen/cryogen">Cryogen</a>
        </p>
      </footer>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="../js/highlight.pack.js" type="text/javascript"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-57222408-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
