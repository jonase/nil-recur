<html>
  <head>
    <meta charset="utf-8"/>
    <title>nil/recur</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <link href="../css/screen.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <h1><a class="navbar-brand" href="/nil-recur/index.html">nil/recur</a></h1>
        </div>
        <!-- nav links -->
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="/nil-recur/index.html">Home</a></li>
            <li ><a href="/nil-recur/archives.html">Archives</a></li>
            
            <li >
              <a href="/nil-recur/pages/about.html">About</a>
            </li>
            
            <li><a href="/nil-recur/feed.xml">RSS</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div id="wrapper" class="container">
      <div class="row">
        <div class="col-md-8">
          <div id="content">
            
<div id="post">
    <div id="post-header">
        <h2>Reusable Om components, part 2</h2>
        <p class="date">December 7, 2014</p>
    </div>
    <div>
        
        <p>In <a href='http://jonase.github.io/nil-recur/posts/29-11-2014-om-select.htm'>part 1</a> of this series we built a declarative <code>select</code> component. In this post we will instead build a <code>table</code> component. We take the same approach but along the way we will find a few interesting limitations and gotchas.</p><p>Let's start the same way as in the previous installment, but this time we'll use a different data set:</p><pre><code>&#40;def posts
  &#91;{:project &quot;Reagent&quot;
    :author &quot;holmsand&quot;
    :url &quot;https://github.com/reagent-project/reagent&quot;}
   {:project &quot;Quiescent&quot;
    :author &quot;levand&quot;
    :url &quot;https://github.com/levand/quiescent&quot;}
   {:project &quot;Reacl&quot;
    :author &quot;active-group&quot;
    :url &quot;https://github.com/active-group/reacl&quot;}
   {:project &quot;Om&quot;
    :author &quot;swannodette&quot;
    :url &quot;https://github.com/swannodette/om&quot;}&#93;&#41;
</code></pre><p>The table component we'll build will be used as follows:</p><pre><code>&#40;om/build table
          {:data projects
           :columns &#91;{:title &quot;Author&quot;
                      :cell-fn :author}
                     {:title &quot;Project&quot;
                      :cell-fn &#40;fn &#91;{:keys &#91;project url&#93;
                                 &#40;dom/a #js {:href url} project&#41;}


</code></pre><p>I hope the above is self-explanatory (at least that's the goal). In particular, the <code>:columns</code> vector is a <strong>declerative description</strong> of the table columns. The <code>cell-fn</code> takes a record and returns something that should be rendered. For "Author" the <code>cell-fn</code> simply returns a string and for the "Project" an anchor tag is returned.</p><p>The table component as described above will work fine until you need to render another component in the cells of a column. For example, say you have created a component <code>voter</code> which you would like to use to vote on the individual projects:</p><pre><code>&#40;defn voter &#91;{:keys &#91;votes on-vote&#93;} owner&#93;
  &#40;om/component
   &#40;dom/span nil
             &#40;dom/button #js {:onClick #&#40;on-vote &#40;inc votes&#41;&#41;} &quot;+&quot;&#41;
             votes
             &#40;dom/button #js {:onClick #&#40;on-vote &#40;dec votes&#41;&#41;} &quot;-&quot;&#41;&#41;&#41;&#41;
</code></pre><p>The <code>voter</code> function is an Om component and we should be able to render it in our table. Let's extend the <code>:columns</code> description with an <code>:cell</code> key:</p><pre><code>&#40;om/build table
          {:data projects
           :columns &#91;{:title &quot;Votes&quot;
                      :cell voter
                      :cell-data-fn &#40;fn &#91;record&#93;
                                      {:votes &lt;number-of-votes&gt;
                                       :on-vote &lt;on-vote-callback&gt;}&#41;
                     {:title &quot;Author&quot;
                      :cell-fn :author}
                     {:title &quot;Project&quot;
                      :cell-fn &#40;fn &#91;{:keys &#91;project url&#93;
                                 &#40;dom/a #js {:href url} project&#41;}

</code></pre><p>Note that we also need a <code>:cell-data-fn</code> key that, given a record returns the data that the <code>cell</code> component needs. In the implementation you will see that <code>:cell-data-fn</code> defaults to <code>identity</code> since it's often the case that the component only needs the actual record.</p><h3><a name="all&#95;the&#95;things&#95;that&#95;won't&#95;work"></a>All the things that won't work</h3><p>For me, the biggest limitation of Om is the lack of support for anonymous and higher order components. For example, it would be great if we wouldn't need both <code>:cell</code> and <code>:cell-fn</code> and for simple cases would be able to write</p><pre><code>&#40;om/build table
          {:data projects
           :columns &#91;{:title &quot;Project&quot;
                      :cell #&#40;om/component &#40;dom/a #js {:href &#40;:url %&#41;} &#40;:name %&#41;&#41;&#41;}
                     ...&#93;}&#41;
</code></pre><p>The above will appear to work, but it does not do what you might expect. A new component (for each record in this case) is created and mounted each time the parent component is rendered! The same story again with higher order components:</p><pre><code>&#40;defn text-component &#91;key&#93;
  &#40;fn &#91;data &#95;&#93;
    &#40;om/component
      &#40;span nil &#40;key data&#41;&#41;&#41;&#41;&#41;

&#40;om/build table
          {:data projects
           :columns &#91;{:title &quot;Author&quot;
                      :cell &#40;text-component :author&#41;}
                     ...&#93;}&#41;
</code></pre><p>The same problem appears here. A new component is created and mounted on each re-render. It might appear to work fine until, for example, you start to loose focus on input elements or experience performance problems.</p><p>I'd love to hear from the other Clojurescript React wrappers out there (reagent, quiescent etc.) if they have found any solutions for these problems. It's my understanding however that React itself has this same limitation and is therefor a fundamental problem which is difficult to get away from (I would be extremely happy to be proven wrong on this issue!). Unfortunately, this means that one of the most powerful abstraction mechanisms in functional programming (= <em>closures</em>) are not available to component authors.</p><h3><a name="example&#95;application"></a>Example application</h3><p>Here's a very simple example application using (and implementing) the <code>table</code> component which sorts the table based on the votes:</p><pre><code>;; table component

&#40;defn table-header &#91;columns owner&#93;
  &#40;om/component
   &#40;dom/thead nil
              &#40;apply dom/tr nil
                     &#40;map #&#40;dom/th nil &#40;:title %&#41;&#41;
                          columns&#41;&#41;&#41;&#41;&#41;

&#40;defn table-body &#91;{:keys &#91;data columns&#93;} owner&#93;
  &#40;om/component
   &#40;apply dom/tbody nil
     &#40;for &#91;record data&#93;
       &#40;apply dom/tr nil
         &#40;for &#91;{:keys &#91;cell-fn cell cell-data-fn&#93;} columns&#93;
           &#40;dom/td nil
             &#40;if cell-fn
               &#40;cell-fn record&#41;
               &#40;om/build cell &#40;&#40;or cell-data-fn identity&#41; record&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;&#41;

&#40;defn table &#91;table-spec owner&#93;
  &#40;om/component
   &#40;dom/table nil
              &#40;om/build table-header &#40;:columns table-spec&#41;&#41;
              &#40;om/build table-body table-spec&#41;&#41;&#41;&#41;


;;; Application

&#40;defn index-by &#91;f coll&#93;
  &#40;reduce &#40;fn &#91;result item&#93;
            &#40;assoc result &#40;f item&#41; item&#41;&#41;
          {}
          coll&#41;&#41;

&#40;def app-state &#40;atom &#40;index-by :name projects&#41;&#41;&#41;

&#40;defn voter &#91;{:keys &#91;votes on-vote&#93;} owner&#93;
  &#40;om/component
   &#40;dom/span nil
             &#40;dom/button #js {:onClick #&#40;on-vote &#40;inc votes&#41;&#41;} &quot;+&quot;&#41;
             votes
             &#40;dom/button #js {:onClick #&#40;on-vote &#40;dec votes&#41;&#41;} &quot;-&quot;&#41;&#41;&#41;&#41;

&#40;defn root-component &#91;data&#93;
  &#40;om/component
   &#40;let &#91;data &#40;om/value data&#41;&#93;
     &#40;om/build table
               {:data &#40;-&gt;&gt; data
                           om/value
                           vals
                           &#40;sort-by #&#40;or &#40;:votes %&#41; 0&#41;&#41;
                           reverse&#41;
                :columns &#91;{:title &quot;Votes&quot;
                           :cell voter
                           :cell-data-fn &#40;fn &#91;record&#93;
                                           {:votes &#40;or &#40;:votes record&#41; 0&#41;
                                            :on-vote &#40;fn &#91;n&#93;
                                                       &#40;swap! app-state
                                                              assoc-in
                                                              &#91;&#40;:name record&#41; :votes&#93;
                                                              n&#41;&#41;}&#41;}
                          {:title &quot;Author&quot;
                           :cell-fn :author}
                          {:title &quot;Project&quot;
                           :cell-fn &#40;fn &#91;{:keys &#91;name url&#93;}&#93;
                                      &#40;dom/a #js {:href url} name&#41;&#41;}&#93;}&#41;&#41;&#41;&#41;

&#40;defn init &#91;&#93;
  &#40;om/root root-component
           app-state
           {:target &#40;.getElementById js/document &quot;app&quot;&#41;}&#41;&#41;
</code></pre><p>If you want to run the application you can clone the <a href='https://github.com/jonase/nil-recur'>nil-recur</a> repo where you can find <a href='https://github.com/jonase/nil-recur/blob/master/examples/src/examples/table&#95;component.cljs'>this example</a>.</p>
    </div>
    
    <div id="tags">
        <b>Tags: </b>
        
        <a href="/nil-recur/tags/om.html">om</a>
        
        <a href="/nil-recur/tags/clojurescript.html">clojurescript</a>
        
    </div>
    

    <div id="prev-next">
        
        
        
        <a href="/nil-recur/posts/29-11-2014-om-select.html">Reusable Om components, part 1 &raquo;</a>
        
    </div>

    


</div>

          </div>
        </div>

        <div class="col-md-3">
          <div id="sidebar">
            <h3>Links</h3>
            <ul id="links">
              <li><a href="https://github.com/jonase">My Github</a></li>
              <li><a href="https://twitter.com/jonasenlund">Twitter</a></li>
              
            </ul>
            <div id="recent">
              <h3>Recent Posts</h3>
              <ul>
                
                <li><a href="/nil-recur/posts/7-12-2014-om-table.html">Reusable Om components, part 2</a></li>
                
                <li><a href="/nil-recur/posts/29-11-2014-om-select.html">Reusable Om components, part 1</a></li>
                
              </ul>
            </div>
            <div id="tags">
              <h3>Tags</h3>
              <ul>
                
                <li><a href="/nil-recur/tags/clojurescript.html">clojurescript</a></li>
                
                <li><a href="/nil-recur/tags/om.html">om</a></li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>
      <footer>Copyright &copy; 2014 Jonas Enlund
        <p style="text-align: center;">
          Powered by <a href="https://github.com/lacarmen/cryogen">Cryogen</a>
        </p>
      </footer>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="../js/highlight.pack.js" type="text/javascript"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-57222408-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
